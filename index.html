<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vinstory Club — каталог</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f8f6f2; --panel:#faf8f4; --card:#fff; --text:#151515; --muted:#777;
      --stroke:#e9e4dc; --shadow:0 1px 1px rgba(20,20,20,.03),0 10px 24px rgba(20,20,20,.06);
      --accent:#111; --accent-soft:#161616; --brand:#c8a96b;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;}

    header{position:sticky;top:0;z-index:50;background:var(--panel);backdrop-filter:saturate(180%) blur(6px);
      border-bottom:1px solid var(--stroke);padding:12px 16px;display:flex;gap:12px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:#fff;border:1px solid var(--stroke);
      display:grid;place-items:center;font-weight:800;letter-spacing:.5px;color:#111;box-shadow:var(--shadow)}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .reset{margin-left:auto;background:#fff;border:1px solid var(--stroke);padding:8px 12px;border-radius:10px;
      color:var(--text);box-shadow:var(--shadow)}

    .filters{position:sticky;top:56px;z-index:40;background:var(--panel);border-bottom:1px solid var(--stroke);
      padding:10px 12px;display:flex;gap:8px;overflow:auto}
    .filters select,.filters input{appearance:none;background:#fff;border:1px solid var(--stroke);color:var(--text);
      padding:10px 12px;border-radius:12px;min-width:120px;box-shadow:var(--shadow)}
    .filters input[type=number]{width:110px}
    .filters input[type=search]{min-width:170px}

    .wrap{padding:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;overflow:hidden;
      display:flex;flex-direction:column;box-shadow:var(--shadow);transition:transform .08s ease}
    .card:active{transform:scale(.995)}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f3f2ef}
    .body{padding:12px;display:flex;flex-direction:column;gap:6px}
    .title{margin:0;font-size:15px;font-weight:700;line-height:1.25;letter-spacing:.2px}
    .meta{margin:0;font-size:12px;color:var(--muted)}
    .price{font-size:15px}
    .actions{display:flex;gap:8px;margin-top:6px}
    .btn{flex:1;background:#fff;border:1px solid var(--stroke);padding:10px 12px;border-radius:12px;color:var(--text);
      text-align:center;text-decoration:none;box-shadow:var(--shadow)}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0e0e0e}
    .btn.primary:active{background:var(--accent-soft)}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid var(--stroke);background:#fff;box-shadow:var(--shadow)}
    .empty{padding:48px 12px;text-align:center;color:var(--muted)}
    @media (min-width:720px){ .filters{top:60px} .grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))} }

    /* Modal */
    .modal{position:fixed;inset:0;z-index:100;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25)}
    .modal.open{display:flex}
    .sheet{width:min(680px,96vw);max-height:92vh;background:#fff;border:1px solid var(--stroke);border-radius:18px;
      overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 48px rgba(0,0,0,.12)}
    .sheet header{position:relative;top:auto;background:#fff;border-bottom:1px solid var(--stroke);
      padding:12px 14px;display:flex;gap:8px;align-items:center}
    .close{margin-left:auto;background:#fff;border:1px solid var(--stroke);color:var(--text);border-radius:10px;padding:8px 10px;box-shadow:var(--shadow)}
    .gallery{background:#fff;display:flex;align-items:center;justify-content:center}
    .big{max-height:54vh;max-width:100%;width:100%;object-fit:contain;background:#fff}
    .strip{display:flex;gap:6px;overflow:auto;padding:8px;background:#f3f2ef;border-top:1px solid var(--stroke)}
    .strip img{height:68px;border-radius:10px;opacity:.88;cursor:pointer;box-shadow:var(--shadow);border:1px solid var(--stroke)}
    .strip img.active{outline:2px solid var(--brand);opacity:1}
    .content{padding:12px 14px;display:flex;flex-direction:column;gap:8px;min-height:0}
    .desc{font-size:14px;line-height:1.45;color:#2b2b2b;white-space:pre-wrap}
    .buy{display:flex;gap:10px;padding:12px 14px;border-top:1px solid var(--stroke);background:#fff}

    /* Skeletons */
    .skeleton{animation:pulse 1.1s infinite alternate;background:#f1efeb;border:1px solid var(--stroke)}
    .s-thumb{width:100%;aspect-ratio:1/1;border-radius:16px}
    .s-line{height:12px;border-radius:8px;margin-top:10px}
    @keyframes pulse{from{opacity:.6}to{opacity:1}}
  </style>
</head>
<body>
  <header>
    <div class="logo">V</div>
    <h1>Vinstory Club</h1>
    <button id="reset" class="reset">Сброс</button>
  </header>

  <div class="filters">
    <input id="q" type="search" placeholder="Поиск (бренд, модель, описание)" />
    <select id="gender">
      <option value="">Пол: все</option>
      <option value="m">Мужские</option>
      <option value="w">Женские</option>
    </select>
    <select id="size">
      <option value="">Размер EU</option>
      <option>36</option><option>37</option><option>38</option><option>39</option><option>40</option>
      <option>41</option><option>42</option><option>43</option><option>44</option><option>45</option>
    </select>
    <input id="minp" type="number" inputmode="numeric" placeholder="Цена от" />
    <input id="maxp" type="number" inputmode="numeric" placeholder="до" />
  </div>

  <div class="wrap">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Пока нет товаров по фильтрам</div>
  </div>

  <!-- Modal details -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <div style="font-weight:700" id="d-title">Товар</div>
        <span class="chip" id="d-chip"></span>
        <button class="close" id="d-close">Закрыть</button>
      </header>
      <div class="gallery">
        <img id="d-big" class="big" src="" alt="Фото товара">
      </div>
      <div id="d-strip" class="strip"></div>
      <div class="content">
        <div class="meta" id="d-gender"></div>
        <div class="price" id="d-price"></div>
        <div class="desc" id="d-desc" style="display:none"></div>
      </div>
      <div class="buy">
        <a id="d-tg" class="btn primary" target="_blank" rel="noopener">Написать в Telegram</a>
        <a id="d-top" class="btn" href="#">Наверх</a>
      </div>
    </div>
  </div>

  <script>
    // Telegram WebApp
    if (window.Telegram && Telegram.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); }

    // --- CONFIG ---
    const supabaseUrl = "https://prtkjlguydfrbekjxmeb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydGtqbGd1eWRmcmJla2p4bWViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NjM5NTEsImV4cCI6MjA3MDQzOTk1MX0.JqHlRNw7IYNtygM3Ot18SR2xrjljlWUFkvqUInm9xeI";
    const CONTACT_LINK = "https://t.me/danissimmooo04";
    // --------------

    const db = supabase.createClient(supabaseUrl, supabaseKey);
    const state = { items: [] };
    const el = (id)=>document.getElementById(id);
    const splitPhotos = (s)=> (s||'').split(/[,;]\s*/).filter(Boolean);

    // Skeletons
    function skeleton(n=6){
      const g = el('grid'); g.innerHTML='';
      for(let i=0;i<n;i++){
        const d=document.createElement('div'); d.className='card';
        d.innerHTML=`<div class="skeleton s-thumb"></div>
                     <div class="body">
                       <div class="skeleton s-line" style="width:60%"></div>
                       <div class="skeleton s-line" style="width:40%"></div>
                     </div>`;
        g.appendChild(d);
      }
    }

    function humanGender(g){
      const v=String(g||'').toLowerCase();
      if(v==='m') return 'Мужские';
      if(v==='w') return 'Женские';
      return 'Унисекс';
    }

    function render(list){
      const grid = el('grid'); grid.innerHTML='';
      if(!list.length){ el('empty').style.display='block'; return; }
      el('empty').style.display='none';
      list.forEach(x=>{
        const photos = splitPhotos(x.photos);
        const cover = (x.cover && x.cover.trim()) ? x.cover : (photos[0] || '');
        const title = `${x.brand||''} ${x.model||''}`.trim();
        const card = document.createElement('div'); card.className='card'; card.tabIndex=0;
        card.innerHTML = `
          <img class="thumb" src="${cover}" alt="${title}" loading="lazy">
          <div class="body">
            <p class="title">${title}</p>
            <p class="meta">${humanGender(x.gender)} · EU: ${x.size_eu ?? '-'}</p>
            <p class="price">${(x.price||0).toLocaleString('ru-RU')} ₽</p>
            <div class="actions">
              <a class="btn primary" href="${CONTACT_LINK}" target="_blank" rel="noopener">Написать</a>
            </div>
          </div>`;
        const open = ()=>openDetails(x);
        card.querySelector('.thumb').addEventListener('click',open);
        card.querySelector('.body').addEventListener('click',open);
        card.addEventListener('keydown',(e)=>{ if(e.key==='Enter') open(); });
        grid.appendChild(card);
      });
    }

    // Фильтрация (включая поиск)
    function applyFilters(){
      const g   = el('gender').value;
      const sVal= el('size').value;
      const min = parseInt(el('minp').value||'0',10);
      const max = parseInt(el('maxp').value||'0',10);
      const q   = (el('q').value||'').trim().toLowerCase();

      let list = [...state.items];

      if (q) {
        list = list.filter(x=>{
          const hay = `${x.brand||''} ${x.model||''} ${x.description||''}`.toLowerCase();
          return hay.includes(q);
        });
      }
      if (g) list = list.filter(x=> (String(x.gender||'').toLowerCase()===g) );

      // «корзина» по размеру: 40 → 39.5..40.5
      if (sVal){
        const s = Number(sVal);
        list = list.filter(x=>{
          const v = Number(x.size_eu);
          if (isNaN(v)) return false;
          return Math.abs(v - s) <= 0.5 + 1e-9;
        });
      }

      if (min) list = list.filter(x=>Number(x.price)>=min);
      if (max) list = list.filter(x=>Number(x.price)<=max);

      render(list);
    }

    function bindFilters(){
      ['gender','size','minp','maxp','q'].forEach(id=> el(id).addEventListener('change', applyFilters));
      ['minp','maxp','q'].forEach(id=> el(id).addEventListener('input', applyFilters));
      el('reset').addEventListener('click', ()=>{
        ['gender','size','minp','maxp','q'].forEach(id=> el(id).value='');
        render(state.items);
      });
    }

    async function load(){
      try{
        skeleton();
        const { data, error } = await db.from('vinstory').select('*').order('id',{ascending:false});
        if(error) throw error;
        state.items = data||[];
        render(state.items);
      }catch(err){
        console.error(err);
        el('empty').style.display='block';
      }
    }

    // ===== Modal =====
    function openDetails(item){
      const photos = splitPhotos(item.photos);
      const title = `${item.brand||''} ${item.model||''}`.trim();
      el('d-title').textContent = title || 'Товар';
      el('d-chip').textContent  = 'EU ' + (item.size_eu||'-');
      el('d-gender').textContent = humanGender(item.gender);
      el('d-price').textContent  = (item.price||0).toLocaleString('ru-RU') + ' ₽';
      el('d-tg').href = CONTACT_LINK;

      const strip = el('d-strip'); strip.innerHTML='';
      function show(i){
        el('d-big').src = photos[i] || '';
        [...strip.children].forEach((c,ix)=>c.classList.toggle('active',ix===i));
      }
      photos.forEach((src,i)=>{
        const t=document.createElement('img'); t.src=src; if(i===0) t.classList.add('active'); t.onclick=()=>show(i);
        strip.appendChild(t);
      });
      show(0);

      // Описание (если есть колонка description)
      const desc = (item.description || '').trim();
      const descEl = el('d-desc');
      if (desc){
        descEl.style.display='block';
        descEl.textContent = desc;
      } else {
        descEl.style.display='none';
        descEl.textContent = '';
      }

      el('modal').classList.add('open'); el('modal').setAttribute('aria-hidden','false');
      document.getElementById('d-top').onclick = (e)=>{e.preventDefault();window.scrollTo({top:0,behavior:'smooth'});};
    }
    el('d-close').onclick=()=>{ el('modal').classList.remove('open'); el('modal').setAttribute('aria-hidden','true'); };
    el('modal').addEventListener('click',(e)=>{ if(e.target.id==='modal') el('d-close').click(); });

    bindFilters(); load();
  </script>
</body>
</html>
