<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vinstory Club — каталог</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#f8f6f2; --panel:#faf8f4; --card:#fff; --text:#1c1c1c; --muted:#7c7c7c;
      --stroke:#e9e4dc; --shadow:0 1px 1px rgba(20,20,20,.03),0 10px 24px rgba(20,20,20,.06);
      --accent:#111; --accent-soft:#161616; --brand:#c8a96b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}
    /* блокируем фон, когда открыта модалка */
    body.lock{overflow:hidden}

    /* Header */
    header{position:sticky;top:0;z-index:50;background:var(--panel);
      backdrop-filter:saturate(180%) blur(6px);
      border-bottom:1px solid var(--stroke);
      padding:12px 16px calc(12px + env(safe-area-inset-top));
      display:flex;gap:12px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:#fff;border:1px solid var(--stroke);
      display:grid;place-items:center;font-weight:800;letter-spacing:.5px;color:#111;box-shadow:var(--shadow)}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .reset{margin-left:auto;background:#fff;border:1px solid var(--stroke);padding:8px 12px;border-radius:10px;color:var(--text);box-shadow:var(--shadow)}

    /* Filters */
    .filters{position:sticky;top:60px;z-index:40;background:var(--panel);border-bottom:1px solid var(--stroke);
      padding:10px 12px;display:flex;gap:8px;overflow:auto}
    .filters select,.filters input{appearance:none;background:#fff;border:1px solid var(--stroke);color:var(--text);
      padding:10px 12px;border-radius:12px;min-width:120px;box-shadow:var(--shadow)}
    .filters input[type=number]{width:110px}
    .filters .q{min-width:160px}

    /* Grid */
    .wrap{padding:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;overflow:hidden;
      display:flex;flex-direction:column;box-shadow:var(--shadow);transition:transform .08s ease}
    .card:active{transform:scale(.995)}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#f3f2ef;display:block}
    .body{padding:12px;display:flex;flex-direction:column;gap:6px}
    .title{margin:0;font-size:15px;font-weight:700;line-height:1.25;letter-spacing:.2px}
    .meta{margin:0;font-size:12px;color:var(--muted)}
    .price{font-size:15px}
    .actions{display:flex;gap:8px;margin-top:6px}
    .btn{flex:1;background:#fff;border:1px solid var(--stroke);
      padding:10px 12px;border-radius:12px;color:var(--text);text-align:center;text-decoration:none;box-shadow:var(--shadow)}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0e0e0e}
    .btn.primary:active{background:var(--accent-soft)}
    .empty{padding:48px 12px;text-align:center;color:var(--muted)}
    @media (min-width:720px){
      .filters{top:64px}
      .grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    }

    /* Modal */
    .modal{position:fixed;inset:0;z-index:100;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.25);overscroll-behavior:contain}
    .modal.open{display:flex}
    .sheet{
      width:min(680px,96vw);max-height:92vh;background:#fff;border:1px solid var(--stroke);
      border-radius:18px;box-shadow:0 24px 48px rgba(0,0,0,.12);
      display:grid;grid-template-rows:
        auto               /* header */
        minmax(220px,52vh) /* gallery */
        auto               /* strip */
        auto               /* content (auto-height) */
        auto;              /* buy */
      overflow:auto;                 /* <- скроллит вся карточка */
      -webkit-overflow-scrolling:touch;
    }
    .sheet header{background:#fff;border-bottom:1px solid var(--stroke);
      padding:12px 14px;display:flex;gap:8px;align-items:center}
    .chip{margin-left:6px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--stroke);background:#fff}
    .close{margin-left:auto;background:#fff;border:1px solid var(--stroke);color:var(--text);
      border-radius:10px;padding:8px 10px;box-shadow:var(--shadow)}
    .gallery{background:#000;display:flex;align-items:center;justify-content:center}
    .big{height:100%;max-width:100%;object-fit:contain;display:block;background:#000}

    .strip{display:flex;gap:6px;overflow:auto hidden;padding:8px;background:#f3f2ef;border-top:1px solid var(--stroke)}
    .strip img{height:68px;border-radius:10px;opacity:.9;cursor:pointer;box-shadow:var(--shadow);border:1px solid var(--stroke)}
    .strip img.active{outline:2px solid var(--brand);opacity:1}

    .content{padding:12px 14px 8px 14px;display:flex;flex-direction:column;gap:10px}
    .desc{font-size:14px;line-height:1.5;color:#2a2a2a}

    .buy{display:flex;gap:10px;padding:12px 14px calc(12px + env(safe-area-inset-bottom)) 14px;
      border-top:1px solid var(--stroke);background:#fff}
    .buy .btn{flex:1}
    a{color:inherit;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div class="logo">V</div>
    <h1>Vinstory Club</h1>
    <button id="reset" class="reset">Сброс</button>
  </header>

  <div class="filters">
    <input id="q" class="q" type="search" placeholder="Поиск: бренд / модель" />
    <select id="gender">
      <option value="">Пол: все</option>
      <option value="m">Мужские</option>
      <option value="w">Женские</option>
    </select>
    <select id="size">
      <option value="">Размер EU</option>
      <option>36</option><option>37</option><option>38</option><option>39</option><option>40</option>
      <option>41</option><option>42</option><option>43</option><option>44</option><option>45</option>
    </select>
    <input id="minp" type="number" inputmode="numeric" placeholder="Цена от" />
    <input id="maxp" type="number" inputmode="numeric" placeholder="до" />
  </div>

  <div class="wrap">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Пока нет товаров по фильтрам</div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <div style="font-weight:700" id="d-title">Товар</div>
        <span class="chip" id="d-chip"></span>
        <button class="close" id="d-close">Закрыть</button>
      </header>
      <div class="gallery"><img id="d-big" class="big" src="" alt="Фото товара"></div>
      <div id="d-strip" class="strip"></div>
      <div class="content">
        <div class="meta" id="d-meta"></div>
        <div class="price" id="d-price"></div>
        <div class="desc" id="d-desc" style="display:none"></div>
      </div>
      <div class="buy">
        <a id="d-tg" class="btn primary" target="_blank" rel="noopener">Написать в Telegram</a>
        <a id="d-top" class="btn" href="#">Наверх</a>
      </div>
    </div>
  </div>

  <script>
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }

    const supabaseUrl = "https://prtkjlguydfrbekjxmeb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydGtqbGd1eWRmcmJla2p4bWViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NjM5NTEsImV4cCI6MjA3MDQzOTk1MX0.JqHlRNw7IYNtygM3Ot18SR2xrjljlWUFkvqUInm9xeI";
    const db = supabase.createClient(supabaseUrl, supabaseKey);

    const CONTACT_LINK = "https://t.me/danissimmooo04";
    const S = { items: [] };
    const $ = id => document.getElementById(id);
    const splitPhotos = s => (s||'').split(/[,;]\s*/).filter(Boolean);
    const niceGender = g => g==='m' ? 'Мужские' : g==='w' ? 'Женские' : 'Унисекс';

    (function skeleton(n=6){
      const g = $('grid'); g.innerHTML='';
      for(let i=0;i<n;i++){
        const d=document.createElement('div'); d.className='card';
        d.innerHTML=`<div style="height:100%;display:flex;flex-direction:column">
          <div style="background:#f1efeb;border:1px solid var(--stroke);border-radius:16px;width:100%;aspect-ratio:1/1"></div>
          <div class="body">
            <div style="height:12px;background:#f1efeb;border-radius:8px;width:60%"></div>
            <div style="height:12px;background:#f1efeb;border-radius:8px;width:40%"></div>
          </div>
        </div>`;
        g.appendChild(d);
      }
    })();

    function render(list){
      const grid = $('grid'); grid.innerHTML='';
      $('empty').style.display = list.length ? 'none' : 'block';
      list.forEach(item=>{
        const photos = splitPhotos(item.photos);
        const cover = item.cover || photos[0] || '';
        const title = `${item.brand||''} ${item.model||''}`.trim();
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `
          <img class="thumb" src="${cover}" alt="${title}" loading="lazy">
          <div class="body">
            <p class="title">${title}</p>
            <p class="meta">${niceGender(item.gender)} • EU: ${item.size_eu ?? '-'}</p>
            <p class="price">${(item.price||0).toLocaleString('ru-RU')} ₽</p>
            <div class="actions">
              <a class="btn primary" data-write>Написать</a>
            </div>
          </div>`;
        const open = ()=>openDetails(item);
        card.addEventListener('click', open);
        card.querySelector('[data-write]').addEventListener('click', (e)=>{
          e.stopPropagation(); window.open(CONTACT_LINK,'_blank','noopener');
        });
        grid.appendChild(card);
      });
    }

    function searchFilter(item, q){
      if(!q) return true;
      const hay = `${item.brand||''} ${item.model||''} ${item.description||''}`.toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function applyFilters(){
      const q = $('q').value.trim();
      const g = $('gender').value;
      const s = $('size').value;
      const min = parseInt(($('minp').value||'').trim(),10);
      const max = parseInt(($('maxp').value||'').trim(),10);

      let list = S.items.filter(it => searchFilter(it, q));
      if(g) list = list.filter(it => (it.gender||'').toLowerCase() === g);
      if(s){
        const target = parseFloat(s);
        list = list.filter(it=>{
          const v = parseFloat(it.size_eu);
          return !isNaN(v) && Math.abs(v - target) <= 0.51; // 39.5–40–40.5 считаем одной корзиной
        });
      }
      if(!isNaN(min)) list = list.filter(it => Number(it.price)>=min);
      if(!isNaN(max)) list = list.filter(it => Number(it.price)<=max);
      render(list);
    }

    ['q','gender','size','minp','maxp'].forEach(id=>{
      const el = $(id); el.addEventListener(id==='q'?'input':'change', applyFilters);
    });
    $('reset').addEventListener('click', ()=>{
      ['q','gender','size','minp','maxp'].forEach(id=> $(id).value='');
      render(S.items); window.scrollTo({top:0,behavior:'smooth'});
    });

    async function load(){
      const { data, error } = await db.from('vinstory').select('*').order('id',{ascending:false});
      if(error){ console.error(error); $('empty').style.display='block'; return; }
      S.items = data||[]; render(S.items);
    }

    // ===== Modal control =====
    function lockBody(on){ document.body.classList.toggle('lock', !!on); }

    function openDetails(item){
      const photos = splitPhotos(item.photos);
      const title = `${item.brand||''} ${item.model||''}`.trim();
      $('d-title').textContent = title;
      $('d-chip').textContent = 'EU ' + (item.size_eu ?? '-');
      $('d-meta').textContent = (item.gender==='m'?'Мужские':item.gender==='w'?'Женские':'Унисекс');
      $('d-price').textContent = (item.price||0).toLocaleString('ru-RU') + ' ₽';
      $('d-tg').href = "https://t.me/danissimmooo04";

      const desc = (item.description||'').trim();
      const dDesc = $('d-desc');
      if(desc){ dDesc.style.display='block'; dDesc.textContent = desc; } else { dDesc.style.display='none'; dDesc.textContent=''; }

      const strip = $('d-strip'); strip.innerHTML='';
      function show(i){
        $('d-big').src = photos[i] || '';
        [...strip.children].forEach((c,ix)=>c.classList.toggle('active',ix===i));
      }
      photos.forEach((src,i)=>{
        const t=document.createElement('img'); t.src=src; if(i===0) t.classList.add('active'); t.onclick=()=>show(i);
        strip.appendChild(t);
      });
      show(0);

      $('modal').classList.add('open'); $('modal').setAttribute('aria-hidden','false');
      lockBody(true);

      // защитим фон от скролла жестами вне карточки (iOS)
      const modalEl = $('modal');
      const blockBg = (e)=>{ if(!e.target.closest('.sheet')) e.preventDefault(); };
      modalEl.addEventListener('wheel', blockBg, {passive:false});
      modalEl.addEventListener('touchmove', blockBg, {passive:false});
      modalEl._blockBg = blockBg;

      $('d-top').onclick = (e)=>{ e.preventDefault(); document.querySelector('.sheet').scrollTo({top:0,behavior:'smooth'}); };
    }

    function closeDetails(){
      const modal = $('modal');
      if(modal._blockBg){
        modal.removeEventListener('wheel', modal._blockBg);
        modal.removeEventListener('touchmove', modal._blockBg);
        modal._blockBg = null;
      }
      modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); lockBody(false);
    }

    $('d-close').onclick = closeDetails;
    $('modal').addEventListener('click',(e)=>{ if(e.target.id==='modal') closeDetails(); });

    load();
  </script>
</body>
</html>
