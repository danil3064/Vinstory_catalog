<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vinstory — каталог</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { --bg:#0b0c10; --card:#101218; --text:#e8eaed; --muted:#a8b0bb; --accent:#6ee7b7; --stroke:#1b1f2a; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:var(--bg);padding:12px 16px;border-bottom:1px solid var(--stroke);display:flex;gap:10px;align-items:center}
    h1{font-size:18px;margin:0;flex:1}
    .filters{display:flex;gap:8px;overflow:auto;padding:10px 16px;border-bottom:1px solid var(--stroke)}
    .filters select,.filters input{background:var(--card);border:1px solid var(--stroke);color:var(--text);padding:10px 12px;border-radius:10px;min-width:120px}
    .filters input[type="number"]{width:120px}
    .wrap{padding:12px 16px 24px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#0f1116}
    .body{padding:10px;display:flex;flex-direction:column;gap:6px}
    .title{margin:0;font-size:14px;font-weight:600;line-height:1.2}
    .meta{margin:0;font-size:12px;color:var(--muted)}
    .price{font-size:14px;color:#b4f5d6}
    .actions{display:flex;gap:8px;margin-top:4px}
    .btn{flex:1;background:#1a1f2b;border:1px solid var(--stroke);padding:10px 12px;border-radius:10px;color:var(--text);text-align:center;text-decoration:none}
    .empty{padding:40px 16px;text-align:center;color:var(--muted)}
    @media (min-width:700px){ .grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))} .title{font-size:16px} .price{font-size:16px} }
    /* modal gallery */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .viewer{background:#000;border-radius:12px;max-width:96vw;max-height:92vh;overflow:hidden}
    .big{display:block;max-height:78vh;max-width:96vw}
    .strip{display:flex;gap:6px;padding:8px;background:#0b0b0b;overflow:auto}
    .strip img{height:68px;border-radius:8px;opacity:.85;cursor:pointer}
    .strip img.active{outline:2px solid #fff;opacity:1}
    .close{position:absolute;top:14px;right:14px;background:#111;color:#fff;border:1px solid #333;border-radius:999px;padding:8px 12px}
  </style>
</head>
<body>
  <header>
    <h1>Vinstory — каталог</h1>
    <button id="reset" class="btn">Сброс</button>
  </header>

  <div class="filters">
    <select id="gender">
      <option value="">Пол: любой</option>
      <option value="m">Мужские</option>
      <option value="w">Женские</option>
      <option value="unisex">Унисекс</option>
    </select>
    <select id="size">
      <option value="">Размер EU</option>
      <option>36</option><option>37</option><option>38</option><option>39</option><option>40</option>
      <option>41</option><option>42</option><option>43</option><option>44</option><option>45</option>
    </select>
    <input id="minp" type="number" inputmode="numeric" placeholder="Цена от" />
    <input id="maxp" type="number" inputmode="numeric" placeholder="до" />
  </div>

  <div class="wrap">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Пока нет товаров по фильтрам</div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <button id="close" class="close">Закрыть</button>
    <div class="viewer">
      <img id="big" class="big" src="" alt="Фото">
      <div id="strip" class="strip"></div>
    </div>
  </div>

  <script>
    // === НАСТРОЙКИ ДЛЯ КОНТАКТА В ТГ ===
    // укажи свой ник бота или аккаунта (например, '@vinstory_shop')
    const TELEGRAM_CONTACT = '@danii3064'; // пришли свой ник — соберу файл с твоим

    const supabaseUrl = "https://prtkjlguydfrbekjxmeb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydGtqbGd1eWRmcmJla2p4bWViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NjM5NTEsImV4cCI6MjA3MDQzOTk1MX0.JqHlRNw7IYNtygM3Ot18SR2xrjljlWUFkvqUInm9xeI";
    const db = supabase.createClient(supabaseUrl, supabaseKey);

    const state = { items: [], filtered: [] };
    const el = (id)=>document.getElementById(id);

    const splitPhotos = (s)=> (s||'').split(/[,;]\s*/).filter(Boolean);
    const tgLink = (title)=>{
      if (!TELEGRAM_CONTACT) return null;
      const base = 'https://t.me/' + TELEGRAM_CONTACT.replace('@','');
      const text = encodeURIComponent('Здравствуйте! Хочу взять: ' + title);
      return base + '?start=' + text; // подойдёт и для аккаунта, и для бота
    };

    function render(list){
      const grid = el('grid'); grid.innerHTML='';
      if(!list.length){ el('empty').style.display='block'; return; }
      el('empty').style.display='none';
      list.forEach(x=>{
        const photos = splitPhotos(x.photos);
        const cover = photos[0] || '';
        const title = (x.brand||'') + ' ' + (x.model||'');
        const a = document.createElement('div'); a.className='card';
        a.innerHTML = `
          <img class="thumb" src="${cover}" alt="${title}" loading="lazy">
          <div class="body">
            <p class="title">${title}</p>
            <p class="meta">Размер EU: ${x.size_eu ?? '-'}</p>
            <p class="price">${(x.price||0).toLocaleString('ru-RU')} ₽</p>
            <div class="actions">
              <a class="btn" href="#" data-photos>Фото</a>
              ${TELEGRAM_CONTACT ? `<a class="btn" href="${tgLink(title)}" target="_blank" rel="noopener">Написать в TG</a>` : ''}
            </div>
          </div>`;
        a.querySelector('[data-photos]').addEventListener('click',(e)=>{e.preventDefault(); openGallery(photos);});
        a.querySelector('.thumb').addEventListener('click',()=>openGallery(photos));
        grid.appendChild(a);
      });
    }

    function applyFilters(){
      const g = el('gender').value;
      const s = el('size').value;
      const min = parseInt(el('minp').value||'0',10);
      const max = parseInt(el('maxp').value||'0',10);
      let list = [...state.items];
      if(g) list = list.filter(x=>(x.gender||'').toLowerCase()===g);
      if(s) list = list.filter(x=>String(x.size_eu)===String(s));
      if(min) list = list.filter(x=>Number(x.price)>=min);
      if(max) list = list.filter(x=>Number(x.price)<=max);
      state.filtered = list;
      render(list);
    }

    function bindFilters(){
      ['gender','size','minp','maxp'].forEach(id=> el(id).addEventListener('change', applyFilters));
      ['minp','maxp'].forEach(id=> el(id).addEventListener('input', applyFilters));
      el('reset').addEventListener('click', ()=>{
        ['gender','size','minp','maxp'].forEach(id=> el(id).value='');
        render(state.items);
      });
    }

    async function load(){
      const { data, error } = await db.from('vinstory').select('*').order('id',{ascending:false});
      if(error){ console.error(error); return; }
      state.items = data||[];
      render(state.items);
    }

    // gallery
    function openGallery(photos){
      if(!photos.length) return;
      const modal=el('modal'), big=el('big'), strip=el('strip');
      strip.innerHTML='';
      function show(i){ big.src=photos[i]; [...strip.children].forEach((c,ix)=>c.classList.toggle('active',ix===i)); }
      photos.forEach((src,i)=>{ const t=document.createElement('img'); t.src=src; if(i===0) t.classList.add('active'); t.onclick=()=>show(i); strip.appendChild(t); });
      show(0);
      modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
    }
    el('close').onclick=()=>{ el('modal').classList.remove('open'); el('modal').setAttribute('aria-hidden','true'); };
    el('modal').addEventListener('click',(e)=>{ if(e.target.id==='modal') el('close').click(); });

    bindFilters();
    load();
  </script>
</body>
</html>