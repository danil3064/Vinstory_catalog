<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vinstory Club — каталог</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg:#0b0c10; --panel:#0f1218; --card:#111522; --text:#f0f3f7; --muted:#9aa4b2;
      --stroke:#1b2130; --accent:#7cf2c6; --accent-2:#4cc7ff; --danger:#ff6b6b;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;}

    /* Header */
    header{position:sticky;top:0;z-index:50;background:linear-gradient(#0c0f14,#0b0c10);border-bottom:1px solid var(--stroke);
            padding:10px 14px;display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:#111825;border:1px solid var(--stroke);
          display:grid;place-items:center;font-weight:800;letter-spacing:.5px}
    h1{margin:0;font-size:17px}
    .reset{margin-left:auto;background:#151b28;border:1px solid var(--stroke);padding:8px 12px;border-radius:10px;color:var(--text)}

    /* Filters */
    .filters{position:sticky;top:56px;z-index:40;background:var(--panel);border-bottom:1px solid var(--stroke);
             padding:10px 12px;display:flex;gap:8px;overflow:auto}
    .filters select,.filters input{appearance:none;background:#121829;border:1px solid var(--stroke);color:var(--text);
       padding:10px 12px;border-radius:10px;min-width:120px}
    .filters input[type=number]{width:110px}

    /* Grid */
    .wrap{padding:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;background:#0d1018}
    .body{padding:10px;display:flex;flex-direction:column;gap:6px}
    .title{margin:0;font-size:14px;font-weight:700;line-height:1.2}
    .meta{margin:0;font-size:12px;color:var(--muted)}
    .price{font-size:15px;color:#b9f8da}
    .actions{display:flex;gap:8px;margin-top:4px}
    .btn{flex:1;background:#141a29;border:1px solid var(--stroke);padding:9px 10px;border-radius:10px;color:var(--text);text-align:center;text-decoration:none}
    .btn.primary{background:rgba(124,242,198,.08);border-color:#21413a}
    .empty{padding:40px 12px;text-align:center;color:var(--muted)}
    @media (min-width:720px){ .filters{top:60px} .grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))} }

    /* Details modal */
    .modal{position:fixed;inset:0;z-index:100;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6)}
    .modal.open{display:flex}
    .sheet{width:min(620px,96vw);max-height:92vh;background:var(--panel);border:1px solid var(--stroke);border-radius:16px;overflow:hidden;
            display:flex;flex-direction:column}
    .sheet header{position:relative;top:auto;background:var(--panel);border-bottom:1px solid var(--stroke);padding:10px 12px;display:flex;gap:8px;align-items:center}
    .close{margin-left:auto;background:#151c2b;border:1px solid var(--stroke);color:var(--text);border-radius:10px;padding:8px 10px}
    .gallery{background:#000;display:flex;align-items:center;justify-content:center}
    .big{max-height:54vh;max-width:100%;width:100%;object-fit:contain;background:#000}
    .strip{display:flex;gap:6px;overflow:auto;padding:8px;background:#0b0b10;border-top:1px solid #111}
    .strip img{height:68px;border-radius:8px;opacity:.85;cursor:pointer}
    .strip img.active{outline:2px solid #fff;opacity:1}
    .content{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .buy{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--stroke);background:var(--panel)}

    /* Skeletons */
    .skeleton{animation:pulse 1.1s infinite alternate;background:#0e1422;border:1px solid var(--stroke)}
    .s-thumb{width:100%;aspect-ratio:1/1;border-radius:14px}
    .s-line{height:12px;border-radius:8px;margin-top:8px}
    @keyframes pulse{from{opacity:.6}to{opacity:1}}
  </style>
</head>
<body>
  <header>
    <div class="logo">V</div>
    <h1>Vinstory Club</h1>
    <button id="reset" class="reset">Сброс</button>
  </header>

  <div class="filters">
    <select id="gender">
      <option value="">Пол: все</option>
      <option value="m">Мужские</option>
      <option value="w">Женские</option>
      <option value="unisex">Унисекс</option>
    </select>
    <select id="size">
      <option value="">Размер EU</option>
      <option>36</option><option>37</option><option>38</option><option>39</option><option>40</option>
      <option>41</option><option>42</option><option>43</option><option>44</option><option>45</option>
    </select>
    <input id="minp" type="number" inputmode="numeric" placeholder="Цена от" />
    <input id="maxp" type="number" inputmode="numeric" placeholder="до" />
  </div>

  <div class="wrap">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Пока нет товаров по фильтрам</div>
  </div>

  <!-- Modal details -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <div style="font-weight:700" id="d-title">Товар</div>
        <button class="close" id="d-close">Закрыть</button>
      </header>
      <div class="gallery">
        <img id="d-big" class="big" src="" alt="Фото товара">
      </div>
      <div id="d-strip" class="strip"></div>
      <div class="content">
        <div id="d-meta" class="meta"></div>
        <div id="d-price" class="price"></div>
      </div>
      <div class="buy">
        <a id="d-tg" class="btn primary" target="_blank" rel="noopener">Написать в Telegram</a>
        <a id="d-photos" class="btn" href="#" onclick="window.scrollTo(0,0)">Наверх</a>
      </div>
    </div>
  </div>

  <script>
    // Telegram WebApp niceness
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }

    const supabaseUrl = "https://prtkjlguydfrbekjxmeb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydGtqbGd1eWRmcmJla2p4bWViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NjM5NTEsImV4cCI6MjA3MDQzOTk1MX0.JqHlRNw7IYNtygM3Ot18SR2xrjljlWUFkvqUInm9xeI";
    const db = supabase.createClient(supabaseUrl, supabaseKey);

    const CONTACT_LINK = "https://t.me/danissimmooo04";
    const state = { items: [] };
    const el = (id)=>document.getElementById(id);
    const splitPhotos = (s)=> (s||'').split(/[,;]\s*/).filter(Boolean);

    // Skeletons while loading
    function skeleton(n=6){
      const g = el('grid'); g.innerHTML='';
      for(let i=0;i<n;i++){ 
        const d=document.createElement('div'); d.className='card';
        d.innerHTML=`<div class="skeleton s-thumb"></div>
                     <div class="body">
                       <div class="skeleton s-line" style="width:60%"></div>
                       <div class="skeleton s-line" style="width:40%"></div>
                     </div>`;
        g.appendChild(d);
      }
    }

    function render(list){
      const grid = el('grid'); grid.innerHTML='';
      if(!list.length){ el('empty').style.display='block'; return; }
      el('empty').style.display='none';
      list.forEach(x=>{
        const photos = splitPhotos(x.photos);
        const cover = photos[0] || '';
        const title = (x.brand||'') + ' ' + (x.model||'');
        const card = document.createElement('div'); card.className='card'; card.tabIndex=0;
        card.innerHTML = `
          <img class="thumb" src="${cover}" alt="${title}" loading="lazy">
          <div class="body">
            <p class="title">${title}</p>
            <p class="meta">Размер EU: ${x.size_eu ?? '-'}</p>
            <p class="price">${(x.price||0).toLocaleString('ru-RU')} ₽</p>
            <div class="actions">
              <a class="btn" href="#" data-open>Открыть</a>
              <a class="btn" href="${CONTACT_LINK}" target="_blank" rel="noopener">Написать</a>
            </div>
          </div>`;
        const open = ()=>openDetails(x);
        card.querySelector('[data-open]').addEventListener('click',(e)=>{e.preventDefault(); open();});
        card.querySelector('.thumb').addEventListener('click',open);
        card.addEventListener('keydown',(e)=>{ if(e.key==='Enter') open(); });
        grid.appendChild(card);
      });
    }

    function applyFilters(){
      const g = el('gender').value;
      const s = el('size').value;
      const min = parseInt(el('minp').value||'0',10);
      const max = parseInt(el('maxp').value||'0',10);
      let list = [...state.items];
      if(g) list = list.filter(x=>(x.gender||'').toLowerCase()===g);
      if(s) list = list.filter(x=>String(x.size_eu)===String(s));
      if(min) list = list.filter(x=>Number(x.price)>=min);
      if(max) list = list.filter(x=>Number(x.price)<=max);
      render(list);
    }

    function bindFilters(){
      ['gender','size','minp','maxp'].forEach(id=> el(id).addEventListener('change', applyFilters));
      ['minp','maxp'].forEach(id=> el(id).addEventListener('input', applyFilters));
      el('reset').addEventListener('click', ()=>{ ['gender','size','minp','maxp'].forEach(id=> el(id).value=''); render(state.items); });
    }

    async function load(){
      try {
        skeleton();
        const { data, error } = await db.from('vinstory').select('*').order('id',{ascending:false});
        if(error) throw error;
        state.items = data||[];
        render(state.items);
      } catch(err) { console.error(err); el('empty').style.display='block'; }
    }

    // ===== Details sheet =====
    function openDetails(item){
      const photos = splitPhotos(item.photos);
      const title = (item.brand||'') + ' ' + (item.model||'');
      el('d-title').textContent = title;
      el('d-meta').textContent = `Пол: ${(item.gender||'-')} · EU ${item.size_eu||'-'}`;
      el('d-price').textContent = (item.price||0).toLocaleString('ru-RU') + ' ₽';
      el('d-tg').href = CONTACT_LINK;
      const strip = el('d-strip'); strip.innerHTML='';
      function show(i){ el('d-big').src = photos[i] || ''; [...strip.children].forEach((c,ix)=>c.classList.toggle('active',ix===i)); }
      photos.forEach((src,i)=>{ const t=document.createElement('img'); t.src=src; if(i===0) t.classList.add('active'); t.onclick=()=>show(i); strip.appendChild(t); });
      show(0);
      el('modal').classList.add('open'); el('modal').setAttribute('aria-hidden','false');
    }
    el('d-close').onclick=()=>{ el('modal').classList.remove('open'); el('modal').setAttribute('aria-hidden','true'); };
    el('modal').addEventListener('click',(e)=>{ if(e.target.id==='modal') el('d-close').click(); });

    bindFilters(); load();
  </script>
</body>
</html>