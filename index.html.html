<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vinstory — каталог</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background:#f6f7f9; color:#111; }
    header { padding:16px 20px; position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; z-index:10; }
    header h1 { margin:0; font-size:18px; }
    .wrap { padding:20px; max-width:1100px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,.04); }
    .thumb { width:100%; aspect-ratio: 1 / 1; object-fit:cover; background:#fafafa; }
    .body { padding:12px; }
    .title { font-size:16px; margin:0 0 6px; }
    .meta { font-size:13px; color:#555; margin:0 0 8px; }
    .price { font-weight:600; }
    .empty { padding:40px 0; text-align:center; color:#666; }
    /* modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; }
    .modal.open { display:flex; }
    .modal-inner { background:#000; padding:0; border-radius:8px; max-width:95vw; max-height:90vh; }
    .modal img { display:block; max-height:90vh; max-width:95vw; }
    .close { position:absolute; top:14px; right:14px; background:#fff; border:none; border-radius:999px; padding:8px 12px; cursor:pointer; }
    .gallery { display:flex; gap:8px; padding:8px; overflow:auto; background:#111; }
    .gallery img { height:72px; cursor:pointer; border-radius:6px; opacity:.8; }
    .gallery img.active { outline:2px solid #fff; opacity:1; }
  </style>
</head>
<body>
  <header><h1>Vinstory — каталог</h1></header>
  <div class="wrap">
    <div id="catalog" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Пока нет товаров</div>
  </div>

  <!-- Modal for gallery -->
  <div id="modal" class="modal" aria-hidden="true">
    <button class="close" id="closeBtn">Закрыть</button>
    <div class="modal-inner">
      <img id="bigImg" src="" alt="Просмотр">
      <div id="thumbs" class="gallery"></div>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://prtkjlguydfrbekjxmeb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydGtqbGd1eWRmcmJla2p4bWViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NjM5NTEsImV4cCI6MjA3MDQzOTk1MX0.JqHlRNw7IYNtygM3Ot18SR2xrjljlWUFkvqUInm9xeI";
    const client = supabase.createClient(supabaseUrl, supabaseKey);

    // helper: split photos by ; or , and trim
    function splitPhotos(s) {
      if (!s) return [];
      return s.split(/[,;]\s*/).filter(Boolean);
    }

    // render cards
    async function load() {
      const { data, error } = await client.from("vinstory").select("*").order("id", { ascending: false });
      if (error) { console.error(error); document.getElementById("empty").style.display="block"; return; }

      const root = document.getElementById("catalog");
      root.innerHTML = "";
      if (!data || !data.length) {
        document.getElementById("empty").style.display = "block";
        return;
      }
      document.getElementById("empty").style.display = "none";

      data.forEach(item => {
        const photos = splitPhotos(item.photos);
        const cover = photos[0] || "";
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <img class="thumb" src="${cover}" alt="${(item.brand||"")+" "+(item.model||"")}" onerror="this.style.display='none'">
          <div class="body">
            <h3 class="title">${item.brand || ""} ${item.model || ""}</h3>
            <p class="meta">Размер EU: ${item.size_eu ?? "-"}</p>
            <p class="meta price">${item.price ? item.price.toLocaleString("ru-RU") + " ₽" : ""}</p>
          </div>
        `;
        // open modal gallery on click
        el.querySelector(".thumb")?.addEventListener("click", () => openGallery(photos));
        root.appendChild(el);
      });
    }

    // simple gallery modal
    function openGallery(photos) {
      if (!photos.length) return;
      const modal = document.getElementById("modal");
      const big = document.getElementById("bigImg");
      const thumbs = document.getElementById("thumbs");
      thumbs.innerHTML = "";
      let current = 0;
      function show(i){ current=i; big.src = photos[i]; [...thumbs.children].forEach((img,idx)=>img.classList.toggle("active", idx===i)); }
      photos.forEach((src,i)=>{
        const img=document.createElement("img"); img.src=src; if(i===0) img.classList.add("active");
        img.addEventListener("click",()=>show(i)); thumbs.appendChild(img);
      });
      show(0);
      modal.classList.add("open"); modal.setAttribute("aria-hidden","false");
    }
    document.getElementById("closeBtn").addEventListener("click", ()=>{
      const modal = document.getElementById("modal");
      modal.classList.remove("open"); modal.setAttribute("aria-hidden","true");
    });
    document.getElementById("modal").addEventListener("click", (e)=>{
      if (e.target.id === "modal") document.getElementById("closeBtn").click();
    });

    load();
  </script>
</body>
</html>
